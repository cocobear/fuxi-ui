<template>
    <div>
        <v-card-title>
            <v-list-item-action>
                <v-icon class="teal--text">mdi-clipboard-list-outline</v-icon>
            </v-list-item-action>
            <v-list-item-content class="ml-n4">
                <v-list-item-title class="teal--text">
                    <span>JSONP 劫持</span>
                </v-list-item-title>
            </v-list-item-content>
        </v-card-title>

        <v-row class="mt-n4 ml-2">
            <v-col cols="12">
            <v-tabs v-model="tab">
                <v-btn @click="openNewTask" elevation="0"  class="mr-8 mt-3 ml-2" small color="teal">
                    <span class="white--text">新建任务</span>
                </v-btn>
                <v-tab key="tasks">
                    任务管理
                </v-tab>
                <v-tab key="help">
                    使用帮助
                </v-tab>
            </v-tabs>

            <v-tabs-items v-model="tab">
                <v-tab-item key="tasks" class="ml-n2">
                    <v-col cols="12">
                        <JsonpTaskManagement ref="JsonpTaskManagement"/>
                    </v-col>
                </v-tab-item>

                <v-tab-item key="help">
                    <v-col cols="12">
                        <JsonpHelp/>
                    </v-col>
                </v-tab-item>
            </v-tabs-items>
            </v-col>
            <v-dialog v-model="newTaskDialogOpen" width="500px">
                <v-card>
                    <v-card-title>
                        <span class="headline">新建任务</span>
                    </v-card-title>
                    <v-card-text>
                        <v-row>
                            <v-col cols="12">
                                <v-text-field
                                        label="任务名称"
                                        class="mr-2 ml-2"
                                        v-model="newTaskData.name"
                                        :rules="[v => !!v || '任务名称为空']"
                                        persistent-hint
                                        required
                                ></v-text-field>
                            </v-col>
                            <v-col cols="7">
                                <v-textarea
                                        class="mr-2 ml-2 mt-n4"
                                        outlined
                                        :rules="[v => !!v || '路径必填']"
                                        v-model="newTaskData.url"
                                        :placeholder="pathPlaceholder"
                                        rows="3"
                                        label="Path"
                                ></v-textarea>
                            </v-col>
                            <v-col cols="12" >
                                <v-btn @click="newTask" small color="teal" class="float-right ml-2 mr-2 mb-4">
                                    <span class="white--text">创建</span>
                                </v-btn>
                            </v-col>
                        </v-row>
                    </v-card-text>
                </v-card>
            </v-dialog>
        </v-row>
    </div>
</template>

<script>
    import JsonpTaskManagement from "./JsonpTaskManagement"
    import JsonpHelp from "./JsonpHelp"
    export default {
        name: "XSSHunter",
        components: {
            JsonpTaskManagement,
            JsonpHelp,
        },
        data: () => ({
            search: "",
            tab: null,
            newTaskDialogOpen: false,
            newTaskData: {name: "", url: ""},
            payloadList: [],
            pathPlaceholder: "Hijacking path,  Example:\nhttp://example.com/api/userinfo",
        }),
        mounted() {
            this.getPayload()
        },
        methods: {
            getPayload() {
                this.$api.exploit.xssPayloadList().then(res => {
                    let response = res.data;
                    let status = response['status'];
                    let result = response['result'];
                    this.payloadList = [];
                    if(status['status'] === "success") {
                        for (let i=0; i<result.length; i++) {
                            this.payloadList.push({
                                value: result[i]['pid'],
                                text: result[i]['name'],
                            })
                        }
                    } else {
                        this.$message.error(status['message']);
                    }
                })
            },
            openNewTask() {
                this.newTaskDialogOpen = true;
                this.getPayload();
                this.newTaskData.name = "jsonp_task_" + this.$tools.getDateTime();

            },
            newTask() {
                this.newTaskDialogOpen = false;
                if (this.newTaskData.name.length===0|| this.newTaskData.url.length===0) {
                    this.$message.error("请检查输入");
                    return
                }
                this.$api.exploit.jsonpNewTask(this.newTaskData).then(res => {
                    let response = res.data;
                    let status = response['status'];
                    if(status['status'] === "success") {
                        this.$message.success(status['message']);
                        this.newTaskData.name = "jsonp_task_" + this.$tools.getDateTime();
                        this.newTaskData.url = "";
                    } else {
                        this.$message.error(status['message']);
                    }
                    this.newTaskDialogOpen = false;
                    this.getData();
                })
            },
        }
    }
</script>

<style scoped>

</style>